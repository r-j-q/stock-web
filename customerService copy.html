<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" type="image/png" href="login/assets/img/ploutos.png" />

    <link rel="stylesheet" href="assets/css/customerService.css" />
    <link rel="stylesheet" href="assets/css/circle-container.css" />

    <title>Stock Plouto</title>
    <style></style>
  </head>

  <body>
    <div class="container">
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>

      <div class="box">
        <div class="">
          <div class="header"></div>

          <div class="content">
            <ul class="list"></ul>

            <div class="content-bottom">
              <img
                src="login/assets/img/ploutos.png"
                class="bottom_pic"
                id="pic"
              />

              <input
                type="text"
                placeholder="Please enter chat content"
                class="myInput"
              />

              <input type="button" value="Send" class="out" />
            </div>
          </div>
        </div>
      </div>
    </div>
    <script
    src="login/assets/js/core/jquery.3.2.1.min.js"
    type="text/javascript"
  ></script>
    <script type="text/javascript">
       var listMessageData = [];


      var out = document.querySelector(".out"); //获取发送按钮
      var myInput = document.querySelector(".myInput");
      var pic = document.getElementById("pic"); //获取图片
      var onOff = false;
      var list = document.querySelector(".list"); //获取ul
      //   var WebSocketUrl = "ws://api.stock-plouto.com:9011/ws?uid=110";
      var WebSocketUrl = "ws://192.168.1.18:9011/ws?uid=1";
      var limitConnect = 3;  // 断线重连次数
      var timeConnect = 0;
      // var baseUrl = "https://api.stock-plouto.com";
      var baseUrl = "http://192.168.1.18:8080";
      var tokens = JSON.parse(localStorage.getItem("userInfo")) || "";
      
      function getHostoryMesssageList() {
        $.ajax({
          type: "post",
          url: baseUrl+"/user/wechat",
          headers: {
          Authorization: `Bearer ${tokens.token}`,
        },
          dataType: "json",

          success: function (msg) {
            if (msg.data.list.length > 0) {
              listMessageData = msg.data.list;
              console.log("------->", listMessageData);
              listMessageData.forEach((item) => {
                item.content = JSON.parse(  item.content);
              });
            }
            $.each(listMessageData, function (index, lists) {
                if(lists.is_admin==1){
                    list.innerHTML  += "<li class='left'><img src='https://stock-plouto.com/login/assets/img/ploutos.png'/><p>" +
                    lists.content.content +
                  "</p></li>"
                }else{ 
                    list.innerHTML  += "<li class='right'><img src='https://stock-plouto.com/login/assets/img/ploutos.png'/><p>" +
                    lists.content.content +
                  "</p></li>"
                }
            })
             
          },
        });
      }
      // is_admin = 0时是客户给销售发的
      getHostoryMesssageList();

     var  ws = new WebSocket(WebSocketUrl);
     
      // 获取连接状态
      console.log("ws连接状态1111111：" + ws.readyState);
      //监听是否连接成功
     
        ws.onopen = function () {
          console.log("ws连接状态111111111：" + ws.readyState);
          //连接成功则发送一个数据
           
        };
     
      // 接听服务器发回的信息并处理展示
      ws.onmessage = function (data) {
        console.log("接收到来自服务器的消息2222222：");
        console.log(data);
        //完成通信后关闭WebSocket连接
        ws.close();
      };
      // 监听连接关闭事件
      ws.onclose = function () {
        reconnect(WebSocketUrl);
        // 监听整个过程中websocket的状态
        console.log("ws连接状态333333：" + ws.readyState);
      };
      // 监听并处理error事件
      ws.onerror = function (error) {
        console.log(error);
      };

      // var out = document.querySelector(".out"); //获取发送按钮

      // var myInput = document.querySelector(".myInput");

      // var pic = document.getElementById("pic"); //获取图片

      // var onOff = false;

      // var list = document.querySelector(".list"); //获取ul

      pic.onclick = function () {
        if (onOff) {
          pic.src = "login/assets/img/ryan.jpg";

          onOff = false;
        } else {
          pic.src = "login/assets/img/ploutos.png";

          onOff = true;
        }
      };

      out.onclick = function () {
        var value = myInput.value; //获取文字内容

        if (value == "") {
          alert("Please enter content");
        } else {
          if (onOff) {
            list.innerHTML +=
              "<li class='left'><img src='login/assets/img/ploutos.png'/><p>" +
              value +
              "</p></li>";
          } else { 
            ws.send(value);
            list.innerHTML +=
              "<li class='right'><img src='login/assets/img/ryan.jpg'/><p>" +
              value +
              "</p></li>";
          }
        }

        myInput.blur((myInput.value = "")); //失去焦点，文本框清空
      };

      document.onkeydown = function (event) {
        var e = event || window.event;
        if (e && e.keyCode == 13) {
          //处理按回车键后的逻辑
          out.onclick();
        }
      };


      function reconnect(service) {
      // lockReconnect加锁，防止onclose、onerror两次重连
      if(limitConnect>0){
          limitConnect --;
          timeConnect ++;
          console.log("第"+timeConnect+"次重连");
          // 进行重连
          setTimeout(function(){
            new WebSocket(service); 
          },2000);

      }else{
        console.log("TCP连接已超时");
      }
    }

    // 心跳 * 回应
    setInterval(function(){
      ws.send('');
    }, 1000*100);
    
    </script>
  </body>
</html>
