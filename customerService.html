<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" type="image/png" href="login/assets/img/ploutos.png" />

    <link rel="stylesheet" href="assets/css/customerService.css" />
    <link rel="stylesheet" href="assets/css/circle-container.css" />

    <title>Stock Plouto</title>
    <style>
      #loadMoreData {
        text-align: center;
        color: #333;
        font-size: 14px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>
      <div class="circle-container">
        <div class="circle"></div>
      </div>

      <div class="box">
        <div class="">
          <div class="header" id="loadMoreData"> More</div>

          <div class="content">
            <div class="content-list">
              <ul class="list" id="contentList"></ul>
            </div>

            <div class="content-bottom">
              <img
                src="login/assets/img/ploutos.png"
                class="bottom_pic"
                id="pic"
              />

              <input
                type="text"
                placeholder="Please enter chat content"
                class="myInput"
              />

              <input type="button" value="Send" class="out" />
            </div>
          </div>
        </div>
      </div>
      <!-- <embed id="wavFileId" 
       src="./assets/11299.wav"
       width="0"
       height="0"
       loop="false" 
       autostart="false">
</embed>  -->
    </div>
    <script
      src="login/assets/js/core/jquery.3.2.1.min.js"
      type="text/javascript"
    ></script>
    <script type="text/javascript">
      var listMessageData = [];
      var listMessageDataForEach = [];
      var loadMoreDataList=[];
      var tokens = JSON.parse(localStorage.getItem("userInfo")) || "";
      var out = document.querySelector(".out"); //获取发送按钮
      var myInput = document.querySelector(".myInput");
      var pic = document.getElementById("pic"); //获取图片
      var onOff = false;
      var list = document.querySelector(".list"); //获取ul
      //   var WebSocketUrl = "ws://api.stock-plouto.com:9011/ws?uid=110";
      // var WebSocketUrl = "ws://192.168.1.24:9011/ws?uid=" + tokens.ID;
      // var WebSocketUrl = "ws://192.168.1.24:9011/ws?uid=1";
      var WebSocketUrl = `wss://websocket.stock-plouto.com/ws?uid=${tokens.ID}&username=${tokens.username}`
      // var WebSocketUrl = "ws://47.252.3.248:9011/ws?uid="

      var limitConnect = 1000000; // 断线重连次数
      var timeConnect = 0;
      var baseUrl = "https://api.stock-plouto.com";
      // var baseUrl = "http://192.168.1.24:8080";
      var openSocket = true;

      webSocketInit(WebSocketUrl);
      var ws;
       if (!tokens?.token) {
         window.location.href = "login.html?customerService=us";
          
      }

       
      $("#loadMoreData").click(function () {
        // let lastid = listMessageData.sort((a, b) => {
        //   return a - b;
        // })[listMessageData.length - 1].ID;


        let lastid = Math.min.apply(Math,  listMessageData.map(item => {
					return item.ID
				}))
        getHostoryMesssageList(lastid);
        console.log("lasid", lastid);
      });
      function scrollBottom(){
        var di = document.getElementById('contentList');
        di.scrollTop = di.scrollHeight;
       }
      function getHostoryMesssageList(lastid) {

        

        $.ajax({
          type: "post",
          url: baseUrl + "/user/wechat?lastid=" + lastid,
          headers: {
            Authorization: `Bearer ${tokens.token}`,
          },
          dataType: "json",

          success: function (msg) {
            if (msg.data.list.length == 0) {
               $("#loadMoreData").hide();
              }
            if (msg.data.list.length > 0) {
              listMessageData = msg.data.list.reverse();
               

              listMessageData.forEach((item) => {
                item.content = JSON.parse(JSON.parse(item.content).content);
              });
              // console.log("==2listMessageData=====>",listMessageData)
 
               listMessageDataForEach.unshift(...listMessageData);
              // console.log("==3loadMoreDataList=====>",loadMoreDataList)
              console.log("==3listMessageDataForEach=====>",listMessageDataForEach)

              $.each(listMessageDataForEach, function (index, lists) {
                if (lists.is_admin == 0) {
                  list.innerHTML +=
                    "<li class='right'><img src='https://stock-plouto.com/login/assets/img/ryan.jpg'/><p>" +
                    lists.content.content +
                    "</p></li>";
                } else {
                  list.innerHTML +=
                    "<li class='left'><img src='https://stock-plouto.com/login/assets/img/ploutos.png'/><p>" +
                    lists.content.content +
                    "</p></li>";
                }
              });
              scrollBottom()
            }
          },
        });
      }
      // is_admin = 0时是客户给销售发的
      getHostoryMesssageList(0);

      pic.onclick = function () {
        if (onOff) {
          pic.src = "login/assets/img/ryan.jpg";

          onOff = false;
        } else {
          pic.src = "login/assets/img/ploutos.png";

          onOff = true;
        }
      };

      out.onclick = function () {
        var value = myInput.value; //获取文字内容

        if (value == "") {
          alert("Please enter content");
        } else {
          console.log("openSocket", openSocket);
          if (openSocket) {
            ws.send(JSON.stringify({ content: value, TextType: 0 }));
            list.innerHTML +=
              "<li class='right'><img src='login/assets/img/ryan.jpg'/><p>" +
              value +
              "</p></li>";
              scrollBottom()

          }

          myInput.blur((myInput.value = "")); //失去焦点，文本框清空
        }
      };

      document.onkeydown = function (event) {
        var e = event || window.event;
        if (e && e.keyCode == 13) {
          //处理按回车键后的逻辑
          out.onclick();
        }
      };

      function webSocketInit(service) {
        ws = new WebSocket(service);
        ws.onopen = function () {
          console.log("已连接TCP服务器");
        };
        ws.onmessage = function (msg) {
          openSocket = true;
          if (
            !JSON.parse(msg.data).content.includes("新socket连接") &&
            JSON.parse(msg.data).isadmin == 1
          ) {
           list.innerHTML +=
              "<li class='left'><img src='https://stock-plouto.com/login/assets/img/ploutos.png'/><p>" +
              JSON.parse(JSON.parse(msg.data).content).content +
              "</p></li>";
          }
          scrollBottom()

          // var nodeItem=document.getElementById("#wavFileId");
          // if(nodeItem!=null){  nodeItem.Play();}  
          // console.log("销售返回信息", msg);
        };
        ws.onclose = function () {
          console.log("服务器已经断开");
          reconnect(service);
          openSocket = false;
        };

        function reconnect(service) {
          if (limitConnect > 0) {
            limitConnect--;
            timeConnect++;
            console.log("第" + timeConnect + "次重连");

            setTimeout(function () {
              webSocketInit(service);
            }, 2000);
          } else {
            console.log("TCP连接已超时");
          }
        }
      }

      setInterval(function () {
        if (openSocket == false) {
          ws = new WebSocket(WebSocketUrl);
          if (ws.readyState === 1) {
            ws.send("");
          }
        }
      }, 5000);

      // 定义函数
    </script>
  </body>
</html>
